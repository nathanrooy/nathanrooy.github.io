<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=author content="Nathan Rooy"><meta name=copyright content="Nathan A. Rooy"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=language content="en"><meta http-equiv=content-language content="en-gb"><link rel=icon type=image/png href=/favicon/favicon.png><meta name=google-site-verification content="vQ6uvoBDOPVq7u67m2fO8RWaxcqsoLrLzmR7CzEo-0k"><meta name=msvalidate.01 content="4903EB9C7ABD70347352DCFAEE0751F5"><meta name=yandex-verification content="d0b7b29586e133fc"><script async defer data-domain=nathanrooy.github.io src=https://plausible.io/js/plausible.js></script><title>Improved routing for OSMnx with Taxicab</title><link rel=canonical href=https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/ itemprop=url><base href=https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/><meta itemprop=name content="Improved routing for OSMnx with Taxicab | Nathan Rooy"><meta itemprop=description content="Improved routing for OpenStreetMap and OSMnx with Taxicab"><meta name=description content="Improved routing for OpenStreetMap and OSMnx with Taxicab"><meta name=application-name content="Improved routing for OSMnx with Taxicab | Nathan Rooy"><meta name=keywords content="openstreetmap,osmnx,python,routing,taxicab,gps points"><meta name=twitter:card content="nathanrooy.github.io"><meta name=twitter:url content="https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/"><meta name=twitter:title content="Improved routing for OSMnx with Taxicab | Nathan Rooy"><meta name=twitter:description content="Improved routing for OpenStreetMap and OSMnx with Taxicab"><meta property="og:title" content="Improved routing for OSMnx with Taxicab"><meta property="og:description" content="Improved routing for OpenStreetMap and OSMnx with Taxicab"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/"><meta property="og:site_name" content="nathanrooy.github.io"><meta itemprop=image content="https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/taxicab_og.png"><meta property="og:image" content="https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/taxicab_og.png"><meta name=twitter:image content="https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/taxicab_og.png"><meta name=twitter:image:src content="https://nathanrooy.github.io/posts/2021-03-12/osmnx-openstreetmap-taxicab-routing/taxicab_og.png"><link rel=alternate type=application/rss+xml href=https://nathanrooy.github.io/index.xml title="Nathan Rooy"><link rel=stylesheet type=text/css media=screen href=https://nathanrooy.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://nathanrooy.github.io/css/main.css></head><body><div class="container wrapper post"><div class=header><div style=width:100%;display:inline class=site-title><a style=display:inline href=https://nathanrooy.github.io/>Nathan Rooy</a>
<a style=float:right;padding-left:10px;display:inline target=_blank href=/index.xml title=rss><img style=margin:0;padding-top:.6em src=/icons/rss_feather.svg width=20 height=20></a>
<a style=float:right;padding-left:10px;display:inline target=_blank href=https://github.com/nathanrooy/ title=github><img style=margin:0;padding-top:.6em src=/icons/github_feather.svg width=20 height=20></a></div><hr style=width:100%;display:inline-block><nav class=nav><ul class=flat><li style=text-align:center;vertical-align:top><a href=/><img height=20px style=margin:0;padding:0 src=/icons/home_feather.svg></a></li><li style=text-align:center;vertical-align:top><a href=/about><img height=20px style=margin:0;padding:0 src=/icons/user_feather.svg></a></li><li style=text-align:center;vertical-align:top><a href=/nyc_biking><img height=20px style=margin:0;padding:0 src=/icons/bicycle.svg></a></li><li><a href=/favorites><img height=20px style=margin:0;padding:0 src=/icons/trending-up_feather.svg></a></li></ul></nav></div><div class=post-header><h1 class=title>Improved routing for OSMnx with Taxicab</h1><div class=meta>Posted: March 12, 2021</div></div><div class=markdown><h3 id=introduction>Introduction</h3><p>If you’ve ever worked on the geospatial side of data science or just have a passion for maps and code, you’ve probably used <a target=_blank href=https://github.com/gboeing/osmnx>OSMnx</a>. It’s a solid Python package that fills the void between <a target=_blank href=https://www.openstreetmap.org/>OpenStreetMap</a> and <a target=_blank href=https://github.com/networkx/networkx>NetworkX</a>. I’ve used it for both work and personal projects, and I really like it a lot. The one thing though that I’ve always found lacking however is the routing functionality&mldr; Let&rsquo;s work through a simple example that demonstrates what I mean. When routing between two longitude/latitude pairs, one first needs to find the nearest nodes like so:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>osmnx</span> <span style=color:#069;font-weight:700>as</span> <span style=color:#0cf;font-weight:700>ox</span>

<span style=color:#09f;font-style:italic># download osm graph</span>
xmin, xmax <span style=color:#555>=</span> <span style=color:#555>-</span><span style=color:#f60>84.323</span>, <span style=color:#555>-</span><span style=color:#f60>84.305</span>
ymin, ymax <span style=color:#555>=</span>  <span style=color:#f60>39.084</span>,  <span style=color:#f60>39.092</span>
G <span style=color:#555>=</span> ox<span style=color:#555>.</span>graph_from_bbox(
    ymax, ymin, xmin, xmax, network_type<span style=color:#555>=</span><span style=color:#c30>&#39;drive&#39;</span>, simplify<span style=color:#555>=</span>True)

<span style=color:#09f;font-style:italic># set origin/destination</span>
orig <span style=color:#555>=</span> (<span style=color:#f60>39.08710</span>, <span style=color:#555>-</span><span style=color:#f60>84.31050</span>)
dest <span style=color:#555>=</span> (<span style=color:#f60>39.08800</span>, <span style=color:#555>-</span><span style=color:#f60>84.32000</span>)

<span style=color:#09f;font-style:italic># find nearest nodes</span>
n_orig <span style=color:#555>=</span> ox<span style=color:#555>.</span>distance<span style=color:#555>.</span>get_nearest_node(G, orig)
n_dest <span style=color:#555>=</span> ox<span style=color:#555>.</span>distance<span style=color:#555>.</span>get_nearest_node(G, dest)
</code></pre></div><p>As which point, you can calculate the shortest route and its distance:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>networkx</span> <span style=color:#069;font-weight:700>as</span> <span style=color:#0cf;font-weight:700>nx</span>
route <span style=color:#555>=</span> nx<span style=color:#555>.</span>shortest_path(G, n_orig, n_dest, <span style=color:#c30>&#39;length&#39;</span>)

edge_lengths <span style=color:#555>=</span> ox<span style=color:#555>.</span>utils_graph<span style=color:#555>.</span>get_route_edge_attributes(
    G, osmnx_route, <span style=color:#c30>&#39;length&#39;</span>)
route_len_m <span style=color:#555>=</span> <span style=color:#366>sum</span>(edge_lengths)
</code></pre></div><p>Which yields a route length of 1665.48 meters. This appears to be all well and good until you do a quick visual inspection.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>fig, ax <span style=color:#555>=</span> ox<span style=color:#555>.</span>plot_graph_route(
    G, osmnx_route, route_color<span style=color:#555>=</span><span style=color:#c30>&#39;darkorange&#39;</span>, show<span style=color:#555>=</span>False, close<span style=color:#555>=</span>False)

ax<span style=color:#555>.</span>scatter(
    G<span style=color:#555>.</span>nodes[n_orig][<span style=color:#c30>&#39;x&#39;</span>], G<span style=color:#555>.</span>nodes[n_orig][<span style=color:#c30>&#39;y&#39;</span>], 
    c<span style=color:#555>=</span><span style=color:#c30>&#39;lime&#39;</span>, s<span style=color:#555>=</span><span style=color:#f60>100</span>, label<span style=color:#555>=</span><span style=color:#c30>&#39;orig&#39;</span>)

ax<span style=color:#555>.</span>scatter(
    G<span style=color:#555>.</span>nodes[n_dest][<span style=color:#c30>&#39;x&#39;</span>], G<span style=color:#555>.</span>nodes[n_dest][<span style=color:#c30>&#39;y&#39;</span>],
    c<span style=color:#555>=</span><span style=color:#c30>&#39;red&#39;</span>, s<span style=color:#555>=</span><span style=color:#f60>100</span>, label<span style=color:#555>=</span><span style=color:#c30>&#39;dest&#39;</span>)

ax<span style=color:#555>.</span>scatter(
    orig[<span style=color:#f60>1</span>], orig[<span style=color:#f60>0</span>],
    color<span style=color:#555>=</span><span style=color:#c30>&#39;lime&#39;</span>, marker<span style=color:#555>=</span><span style=color:#c30>&#39;x&#39;</span>, s<span style=color:#555>=</span><span style=color:#f60>100</span>, label<span style=color:#555>=</span><span style=color:#c30>&#39;orig-point&#39;</span>)

ax<span style=color:#555>.</span>scatter(
    dest[<span style=color:#f60>1</span>], dest[<span style=color:#f60>0</span>],
    color<span style=color:#555>=</span><span style=color:#c30>&#39;red&#39;</span>, marker<span style=color:#555>=</span><span style=color:#c30>&#39;x&#39;</span>, s<span style=color:#555>=</span><span style=color:#f60>100</span>, label<span style=color:#555>=</span><span style=color:#c30>&#39;dest-point&#39;</span>)

plt<span style=color:#555>.</span>legend()
plt<span style=color:#555>.</span>show()
</code></pre></div><figure><img src=osmnx.svg alt="OSMnx route"><figcaption><p>OSMnx route</p></figcaption></figure><p>Ouch, not what we really wanted&mldr; I&rsquo;ve ran into this problem enough times in the past that I decided to finally write my own routing module. I call it <a target=_blank href=https://github.com/nathanrooy/taxicab>Taxicab</a> because it picks you up and drops you off pretty close to where you specify. Under the hood, Taxicab is using a combination of the OpenStreetMap graph (which is what OSMnx uses) as well as the actual road/sidewalk geometry which are represented by <a target=_blank href=https://github.com/Toblerity/Shapely>Shapely</a> <a target=_blank href=https://shapely.readthedocs.io/en/latest/manual.html#linestrings>LineString objects</a>. Additionally, I&rsquo;ve repurposed my old <a target=_blank href=https://nathanrooy.github.io/posts/2016-12-18/vincenty-formula-with-python/>Vincenty</a> distance function and tried to maintain the same interface as OSMnx.</p><p>Now, let&rsquo;s try routing with Taxicab. First install it with the following:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>pip install taxicab
</code></pre></div><p>Next, instead of finding the nearest nodes like previously, we&rsquo;ll pass in the actual longitude/latitude pairs.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>taxicab</span> <span style=color:#069;font-weight:700>as</span> <span style=color:#0cf;font-weight:700>tc</span>
route <span style=color:#555>=</span> tc<span style=color:#555>.</span>distance<span style=color:#555>.</span>shortest_path(G, orig, dest)
</code></pre></div><p>Which yields a distance of 669.05 meters. A bit different, so let&rsquo;s validate with a quick visual inspection.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>fig, ax <span style=color:#555>=</span> tc<span style=color:#555>.</span>plot<span style=color:#555>.</span>plot_graph_route(
    G, route, figsize<span style=color:#555>=</span>(<span style=color:#f60>10</span>,<span style=color:#f60>10</span>), show<span style=color:#555>=</span>False, close<span style=color:#555>=</span>False)

ax<span style=color:#555>.</span>scatter(orig[<span style=color:#f60>1</span>], orig[<span style=color:#f60>0</span>],
    color<span style=color:#555>=</span><span style=color:#c30>&#39;lime&#39;</span>, marker<span style=color:#555>=</span><span style=color:#c30>&#39;x&#39;</span>, s<span style=color:#555>=</span><span style=color:#f60>100</span>, label<span style=color:#555>=</span><span style=color:#c30>&#39;orig-point&#39;</span>)

ax<span style=color:#555>.</span>scatter(dest[<span style=color:#f60>1</span>], dest[<span style=color:#f60>0</span>],
    color<span style=color:#555>=</span><span style=color:#c30>&#39;red&#39;</span>, marker<span style=color:#555>=</span><span style=color:#c30>&#39;x&#39;</span>, s<span style=color:#555>=</span><span style=color:#f60>100</span>, label<span style=color:#555>=</span><span style=color:#c30>&#39;dest-point&#39;</span>)

plt<span style=color:#555>.</span>legend()
plt<span style=color:#555>.</span>show()
</code></pre></div><figure><img src=taxicab.svg alt="Taxicab route"><figcaption><p>Taxicab route</p></figcaption></figure><p>Hey, not too bad! There is still room for improvement, but I&rsquo;ll deal with that later&mldr;</p><h3 id=final-thoughts>Final Thoughts</h3><p>The default routing functionality that ships with OSMnx is great and I&rsquo;m guessing works just fine for the vast majority of what people are doing. However if you need something a little more accurate and are fine with the computational burden of a Vincenty based distance function, than give Taxicab a try! For further documentation and usage examples, see the Github repo [<a target=_blank href=https://github.com/nathanrooy/taxicab>here</a>].</p><p>- Nathan</p></div><hr></div><div class=footer><center>&copy; <a href=/about>Nathan A. Rooy</a>.<br>Built with <a target=_blank href=https://gohugo.io/ rel=nofollow>Hugo</a>.
Powered by <a target=_blank href=http://www.github.com>GitHub</a></center></div></body></html>