<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=author content="Nathan Rooy"><meta name=copyright content="Nathan A. Rooy"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=language content="en"><meta http-equiv=content-language content="en-gb"><link rel=icon type=image/png href=/favicon/favicon.png><meta name=google-site-verification content="vQ6uvoBDOPVq7u67m2fO8RWaxcqsoLrLzmR7CzEo-0k"><meta name=msvalidate.01 content="4903EB9C7ABD70347352DCFAEE0751F5"><script defer data-domain=nathanrooy.github.io src=https://plausible.io/js/plausible.js></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><meta property="og:title" content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python"><meta property="og:description" content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="https://nathanrooy.github.io/posts/2017-11-30/evolving-simple-organisms-using-a-genetic-algorithm-and-deep-learning/"><meta property="og:site_name" content="nathanrooy.github.io"><meta property="og:image" content="https://nathanrooy.github.io/about/DSC_3706-EDIT-BLOG-TINY.jpg"><title>Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python</title><link rel=canonical href=https://nathanrooy.github.io/posts/2017-11-30/evolving-simple-organisms-using-a-genetic-algorithm-and-deep-learning/ itemprop=url><base href=https://nathanrooy.github.io/posts/2017-11-30/evolving-simple-organisms-using-a-genetic-algorithm-and-deep-learning/><meta itemprop=name content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python | Nathan Rooy"><meta itemprop=description content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python"><meta itemprop=image content="https://nathanrooy.github.io/about/DSC_3706-EDIT-BLOG-TINY.jpg"><meta name=description content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python"><meta name=application-name content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python | Nathan Rooy"><meta name=twitter:card content="nathanrooy.github.io"><meta name=twitter:url content="https://nathanrooy.github.io/posts/2017-11-30/evolving-simple-organisms-using-a-genetic-algorithm-and-deep-learning/"><meta name=twitter:title content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python | Nathan Rooy"><meta name=twitter:description content="Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python"><meta name=twitter:image content="https://nathanrooy.github.io/about/DSC_3706-EDIT-BLOG-TINY.jpg"><link rel=alternate type=application/rss+xml href=https://nathanrooy.github.io/index.xml title="Nathan Rooy"><link rel=stylesheet type=text/css media=screen href=https://nathanrooy.github.io/css/normalize.min.02d927c3d7aee93f4557abffff0169f2c90a749e49700a80350d5b3f2911e20a.css><link rel=stylesheet type=text/css media=screen href=https://nathanrooy.github.io/css/main.min.31d10ac7989292397ae7984cb63c02d2cb22403326b95ae8b11434487622e26d.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><div class="container wrapper post"><div class=post-header><h1 class=title>Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python</h1><div class=meta><a href=/>Nathan Rooy</a> | November 30, 2017</div></div><p class=TLDR><strong>TL;DR</strong> - Learn how to evolve a population of simple organisms each containing a unique neural network using a genetic algorithm.</p><div class=markdown><h2>Introduction</h2><p>A few weeks ago I got pretty deep into a late night <a target=_blank href=http://youtube-rabbit-hole.urbanup.com/9025238>YouTube rabbit hole</a>, and somewhere around <a target=_blank href=https://youtu.be/HgWQ-gPIvt4>evolving soft body robots</a>, I came across this video (<a target=_blank href=https://youtu.be/TC5jzw05mNo>here</a>). I'm not sure what if it was the peaceful background music or the hypnotizing motion of the dragonflies but I wanted to try and run the simulation on my local computer. After failing to find a GitHub repo for this, I decided to spend a few hours coding my own version in Python. I was pretty happy with the end results so I decided to turn it into a tutorial.</p><p>During this post, well code from scratch a simulation environment that contains organisms that must consume as much as food as possible in order to survive (click <a href=#results>here</a> to see the final results). If these organisms were people, they would be competitive eaters.</p><p><center><fig><img src=hot-dog-eating-contest.gif></fig></center></p><h2>Neural Network and Navigation</h2><p>Starting off with the basics, the organisms will be controlled by a simple, fully connected <a target=_blank href=https://en.wikipedia.org/wiki/Artificial_neural_network>neural network</a>. The input for the neural network will be a normalized value ranging from , representing the direction to the nearest food particle. This heading is calculated by taking the direction to the nearest food particle (which ranges from +/- 180 degrees) and dividing it by 180. Below are two navigation examples.</p><p><center><fig><img alt="organism heading calculation" title="organism heading calculation" src=heading-calculation.png></fig></center></p><p>Because our single input ranges from and our desired outputs also range from , the <a target=_blank href=https://en.wikipedia.org/wiki/Hyperbolic_function>tanh</a> will make the ideal <a target=_blank href=https://en.wikipedia.org/wiki/Activation_function>activation function</a>. Below is a diagram of the neural network with its inputs and outputs as well as its hidden layer. There exists many excellent tutorials on neural networks online so I wont go into great detail here. I recommend the following to those that are interested: <a target=_blank href=https://youtu.be/aircAruvnKk>here</a>, <a target=_blank href=https://gormanalysis.com/introduction-to-neural-networks/>here</a>, <a target=_blank href=https://gormanalysis.com/neural-networks-a-worked-example/>here</a>, and <a target=_blank href=http://neuralnetworksanddeeplearning.com/>here</a>.</p><p><center><fig><img src=organism-neural-network.png></fig></center></p><p>Since the neural network is nothing more than simple matrix multiplication, it only takes up a few lines of code thanks to <a target=_blank href=http://www.numpy.org/>NumPy</a>. During the evolution process, it's these weights that will be optimized. Lastly, I have set the default number of hidden nodes to five, but this can be increased or decreased to your liking.</p><h2>Organism</h2><p>The organism class is the star of the show here. It contains the neural network, as well as functions for updating its heading, velocity, and position. When an organism is initialized for the first time, its position, heading, velocity, acceleration, and neural network weights are all randomly generated.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>organism</span>():
    <span style=color:#069;font-weight:700>def</span> __init__(self, settings, wih<span style=color:#555>=</span>None, who<span style=color:#555>=</span>None, name<span style=color:#555>=</span>None):
        
        self<span style=color:#555>.</span>x <span style=color:#555>=</span> uniform(settings[<span style=color:#c30>&#39;x_min&#39;</span>], settings[<span style=color:#c30>&#39;x_max&#39;</span>])  <span style=color:#09f;font-style:italic># position (x)</span>
        self<span style=color:#555>.</span>y <span style=color:#555>=</span> uniform(settings[<span style=color:#c30>&#39;y_min&#39;</span>], settings[<span style=color:#c30>&#39;y_max&#39;</span>])  <span style=color:#09f;font-style:italic># position (y)</span>

        self<span style=color:#555>.</span>r <span style=color:#555>=</span> uniform(<span style=color:#f60>0</span>,<span style=color:#f60>360</span>)                 <span style=color:#09f;font-style:italic># orientation   [0, 360]</span>
        self<span style=color:#555>.</span>v <span style=color:#555>=</span> uniform(<span style=color:#f60>0</span>,settings[<span style=color:#c30>&#39;v_max&#39;</span>])   <span style=color:#09f;font-style:italic># velocity      [0, v_max]</span>
        self<span style=color:#555>.</span>dv <span style=color:#555>=</span> uniform(<span style=color:#555>-</span>settings[<span style=color:#c30>&#39;dv_max&#39;</span>], settings[<span style=color:#c30>&#39;dv_max&#39;</span>])   <span style=color:#09f;font-style:italic># dv</span>

        self<span style=color:#555>.</span>d_food <span style=color:#555>=</span> <span style=color:#f60>100</span>   <span style=color:#09f;font-style:italic># distance to nearest food</span>
        self<span style=color:#555>.</span>r_food <span style=color:#555>=</span> <span style=color:#f60>0</span>     <span style=color:#09f;font-style:italic># orientation to nearest food</span>
        self<span style=color:#555>.</span>fitness <span style=color:#555>=</span> <span style=color:#f60>0</span>    <span style=color:#09f;font-style:italic># fitness (food count)</span>

        self<span style=color:#555>.</span>wih <span style=color:#555>=</span> wih
        self<span style=color:#555>.</span>who <span style=color:#555>=</span> who

        self<span style=color:#555>.</span>name <span style=color:#555>=</span> name
        
        
    <span style=color:#09f;font-style:italic># NEURAL NETWORK</span>
    <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>think</span>(self):

        <span style=color:#09f;font-style:italic># SIMPLE MLP</span>
        af <span style=color:#555>=</span> <span style=color:#069;font-weight:700>lambda</span> x: np<span style=color:#555>.</span>tanh(x)               <span style=color:#09f;font-style:italic># activation function</span>
        h1 <span style=color:#555>=</span> af(np<span style=color:#555>.</span>dot(self<span style=color:#555>.</span>wih, self<span style=color:#555>.</span>r_food))  <span style=color:#09f;font-style:italic># hidden layer</span>
        out <span style=color:#555>=</span> af(np<span style=color:#555>.</span>dot(self<span style=color:#555>.</span>who, h1))          <span style=color:#09f;font-style:italic># output layer</span>

        <span style=color:#09f;font-style:italic># UPDATE dv AND dr WITH MLP RESPONSE</span>
        self<span style=color:#555>.</span>nn_dv <span style=color:#555>=</span> <span style=color:#366>float</span>(out[<span style=color:#f60>0</span>])   <span style=color:#09f;font-style:italic># [-1, 1]  (accelerate=1, deaccelerate=-1)</span>
        self<span style=color:#555>.</span>nn_dr <span style=color:#555>=</span> <span style=color:#366>float</span>(out[<span style=color:#f60>1</span>])   <span style=color:#09f;font-style:italic># [-1, 1]  (left=1, right=-1)</span>

        
    <span style=color:#09f;font-style:italic># UPDATE HEADING</span>
    <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>update_r</span>(self, settings):
        self<span style=color:#555>.</span>r <span style=color:#555>+=</span> self<span style=color:#555>.</span>nn_dr <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;dr_max&#39;</span>] <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;dt&#39;</span>]
        self<span style=color:#555>.</span>r <span style=color:#555>=</span> self<span style=color:#555>.</span>r <span style=color:#555>%</span> <span style=color:#f60>360</span>

        
    <span style=color:#09f;font-style:italic># UPDATE VELOCITY</span>
    <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>update_vel</span>(self, settings):
        self<span style=color:#555>.</span>v <span style=color:#555>+=</span> self<span style=color:#555>.</span>nn_dv <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;dv_max&#39;</span>] <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;dt&#39;</span>]
        <span style=color:#069;font-weight:700>if</span> self<span style=color:#555>.</span>v <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>: self<span style=color:#555>.</span>v <span style=color:#555>=</span> <span style=color:#f60>0</span>
        <span style=color:#069;font-weight:700>if</span> self<span style=color:#555>.</span>v <span style=color:#555>&gt;</span> settings[<span style=color:#c30>&#39;v_max&#39;</span>]: self<span style=color:#555>.</span>v <span style=color:#555>=</span> settings[<span style=color:#c30>&#39;v_max&#39;</span>]

    
    <span style=color:#09f;font-style:italic># UPDATE POSITION</span>
    <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>update_pos</span>(self, settings):
        dx <span style=color:#555>=</span> self<span style=color:#555>.</span>v <span style=color:#555>*</span> cos(radians(self<span style=color:#555>.</span>r)) <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;dt&#39;</span>]
        dy <span style=color:#555>=</span> self<span style=color:#555>.</span>v <span style=color:#555>*</span> sin(radians(self<span style=color:#555>.</span>r)) <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;dt&#39;</span>]
        self<span style=color:#555>.</span>x <span style=color:#555>+=</span> dx
        self<span style=color:#555>.</span>y <span style=color:#555>+=</span> dy</code></pre></div><h2>Food</h2><p>The only other class we need to create is the food class. This is a simple object that contains an x/y location and an energy value. This energy value will directly impact the organisms fitness. For now, this energy value remains constant and set at one, but it can be randomized or changed to anything if you feel like modifying it to. Additionally, a <i>respawn</i> function is present to regenerate the location of the food particle once it as been consumed by an organism. This keeps the total number of food particles within each simulation time step constant.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>food</span>():
    <span style=color:#069;font-weight:700>def</span> __init__(self, settings):
        self<span style=color:#555>.</span>x <span style=color:#555>=</span> uniform(settings[<span style=color:#c30>&#39;x_min&#39;</span>], settings[<span style=color:#c30>&#39;x_max&#39;</span>])
        self<span style=color:#555>.</span>y <span style=color:#555>=</span> uniform(settings[<span style=color:#c30>&#39;y_min&#39;</span>], settings[<span style=color:#c30>&#39;y_max&#39;</span>])
        self<span style=color:#555>.</span>energy <span style=color:#555>=</span> <span style=color:#f60>1</span>

    <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>respawn</span>(self,settings):
        self<span style=color:#555>.</span>x <span style=color:#555>=</span> uniform(settings[<span style=color:#c30>&#39;x_min&#39;</span>], settings[<span style=color:#c30>&#39;x_max&#39;</span>])
        self<span style=color:#555>.</span>y <span style=color:#555>=</span> uniform(settings[<span style=color:#c30>&#39;y_min&#39;</span>], settings[<span style=color:#c30>&#39;y_max&#39;</span>])
        self<span style=color:#555>.</span>energy <span style=color:#555>=</span> <span style=color:#f60>1</span></code></pre></div><h2>Evolution</h2><p>The organism will be optimized using a <a target=_blank href=https://en.wikipedia.org/wiki/Genetic_algorithm>genetic algorithm</a> (GA) which falls under the larger umbrella of <a target=_blank href=https://en.wikipedia.org/wiki/Evolutionary_algorithm>evolutionaty algorithms</a> (EA). Genetic algorithms work by imitating the natural biological process of evolution by starting off with an initial population, and through <a target=_blank href=https://en.wikipedia.org/wiki/Selection_(genetic_algorithm)>selection</a>, <a target=_blank href=https://en.wikipedia.org/wiki/Crossover_(genetic_algorithm)>crossover</a>, and <a target=_blank href=https://en.wikipedia.org/wiki/Mutation_(genetic_algorithm)>mutation</a> over many generations, an optimal solution emerges. With that said, EAs are not numerically guaranteed to find the global optimum but given proper initial conditions they are exceptionally good at searching through the design space and finding optimal or near optimal solutions. For this tutorial, the EA scheme will be as follows:</p><ul class=ul-style-a style=list-style-type:none><li><p markdown=1><b>Selection</b> - The simplest form of selection is called <i>elitism</i>, this is where the top n% of the current generations fittest individuals are selected and carried over to the next generation.</p></li><li><p markdown=1><b>Crossover</b> - Using the same pool of individuals selected during the elitism step previously, pairs of individuals will be randomly selected as parents and a new offspring will be generated. Because we're dealing with the weights of the neural network, the following equation will be used to crossover traits between the two parents to the resulting offspring:
<equation class=has-jax>$$ offspring=parent_1(a) + parent_2(1-a) $$</equation>
Where <equation class=has-jax>\( a \)</equation> is a randomly generated value between zero and one, and <equation class=has-jax>\( parent_1 \)</equation>, and <equation class=has-jax>\( parent_2 \)</equation> represent the weights of the neural network. Because there are two matrices that are being blending together (wih and who), the implementation will actually be as follows:
<equation class=has-jax>$$ offspring\_wih=parent\_wih_1(a) + parent\_wih_2(1-a) $$</equation>
<equation class=has-jax>$$ offspring\_who=parent\_who_1(a) + parent\_who_2(1-a) $$</equation></p></li><li><p markdown=1><b>Mutation</b> - Lastly, once the new offspring has been generated, a random number between zero and one will be generated. If this value is below the user initialized mutation threshold, mutation will occur. In the event that mutation does occur, a random weight from one of the two neural network weight matrices will be replaced with a random value that is within +/- 10% of the original value. This will create just a slight variation within the organism that could potentially lead to a fitter organism. The mutation effect is limited to +/- 10% of the original value because we want to avoid causing catastrophic failure within the neural network and potentially paralyzing the organism.</p></li></ul><p>The diagram below shows just how simple this EA scheme is.</p><p><center><fig><img alt="organism evolution" title="organism evolution" src=organism-evolution.png></fig></center></p><p>And finally, the codified EA routine can be seen below:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>evolve</span>(settings, organisms_old, gen):

    elitism_num <span style=color:#555>=</span> <span style=color:#366>int</span>(floor(settings[<span style=color:#c30>&#39;elitism&#39;</span>] <span style=color:#555>*</span> settings[<span style=color:#c30>&#39;pop_size&#39;</span>]))
    new_orgs <span style=color:#555>=</span> settings[<span style=color:#c30>&#39;pop_size&#39;</span>] <span style=color:#555>-</span> elitism_num

    <span style=color:#09f;font-style:italic>#--- GET STATS FROM CURRENT GENERATION ----------------+</span>
    stats <span style=color:#555>=</span> defaultdict(<span style=color:#366>int</span>)
    <span style=color:#069;font-weight:700>for</span> org <span style=color:#000;font-weight:700>in</span> organisms_old:
        <span style=color:#069;font-weight:700>if</span> org<span style=color:#555>.</span>fitness <span style=color:#555>&gt;</span> stats[<span style=color:#c30>&#39;BEST&#39;</span>] <span style=color:#000;font-weight:700>or</span> stats[<span style=color:#c30>&#39;BEST&#39;</span>] <span style=color:#555>==</span> <span style=color:#f60>0</span>:
            stats[<span style=color:#c30>&#39;BEST&#39;</span>] <span style=color:#555>=</span> org<span style=color:#555>.</span>fitness

        <span style=color:#069;font-weight:700>if</span> org<span style=color:#555>.</span>fitness <span style=color:#555>&lt;</span> stats[<span style=color:#c30>&#39;WORST&#39;</span>] <span style=color:#000;font-weight:700>or</span> stats[<span style=color:#c30>&#39;WORST&#39;</span>] <span style=color:#555>==</span> <span style=color:#f60>0</span>:
            stats[<span style=color:#c30>&#39;WORST&#39;</span>] <span style=color:#555>=</span> org<span style=color:#555>.</span>fitness
            
        stats[<span style=color:#c30>&#39;SUM&#39;</span>] <span style=color:#555>+=</span> org<span style=color:#555>.</span>fitness
        stats[<span style=color:#c30>&#39;COUNT&#39;</span>] <span style=color:#555>+=</span> <span style=color:#f60>1</span>

    stats[<span style=color:#c30>&#39;AVG&#39;</span>] <span style=color:#555>=</span> stats[<span style=color:#c30>&#39;SUM&#39;</span>] <span style=color:#555>/</span> stats[<span style=color:#c30>&#39;COUNT&#39;</span>]
    
    
    <span style=color:#09f;font-style:italic>#--- ELITISM (KEEP BEST PERFORMING ORGANISMS) ---------+</span>
    orgs_sorted <span style=color:#555>=</span> <span style=color:#366>sorted</span>(organisms_old, key<span style=color:#555>=</span>operator<span style=color:#555>.</span>attrgetter(<span style=color:#c30>&#39;fitness&#39;</span>), reverse<span style=color:#555>=</span>True)
    organisms_new <span style=color:#555>=</span> []
    <span style=color:#069;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> <span style=color:#366>range</span>(<span style=color:#f60>0</span>, elitism_num):
        organisms_new<span style=color:#555>.</span>append(organism(settings, wih<span style=color:#555>=</span>orgs_sorted[i]<span style=color:#555>.</span>wih, who<span style=color:#555>=</span>orgs_sorted[i]<span style=color:#555>.</span>who, name<span style=color:#555>=</span>orgs_sorted[i]<span style=color:#555>.</span>name))

    
    <span style=color:#09f;font-style:italic>#--- GENERATE NEW ORGANISMS ---------------------------+</span>
    <span style=color:#069;font-weight:700>for</span> w <span style=color:#000;font-weight:700>in</span> <span style=color:#366>range</span>(<span style=color:#f60>0</span>, new_orgs):

        <span style=color:#09f;font-style:italic># SELECTION (TRUNCATION SELECTION)</span>
        canidates <span style=color:#555>=</span> <span style=color:#366>range</span>(<span style=color:#f60>0</span>, elitism_num)
        random_index <span style=color:#555>=</span> sample(canidates, <span style=color:#f60>2</span>)
        org_1 <span style=color:#555>=</span> orgs_sorted[random_index[<span style=color:#f60>0</span>]]
        org_2 <span style=color:#555>=</span> orgs_sorted[random_index[<span style=color:#f60>1</span>]]

        <span style=color:#09f;font-style:italic># CROSSOVER</span>
        crossover_weight <span style=color:#555>=</span> random()
        wih_new <span style=color:#555>=</span> (crossover_weight <span style=color:#555>*</span> org_1<span style=color:#555>.</span>wih) <span style=color:#555>+</span> ((<span style=color:#f60>1</span> <span style=color:#555>-</span> crossover_weight) <span style=color:#555>*</span> org_2<span style=color:#555>.</span>wih)
        who_new <span style=color:#555>=</span> (crossover_weight <span style=color:#555>*</span> org_1<span style=color:#555>.</span>who) <span style=color:#555>+</span> ((<span style=color:#f60>1</span> <span style=color:#555>-</span> crossover_weight) <span style=color:#555>*</span> org_2<span style=color:#555>.</span>who)
        
        <span style=color:#09f;font-style:italic># MUTATION</span>
        mutate <span style=color:#555>=</span> random()
        <span style=color:#069;font-weight:700>if</span> mutate <span style=color:#555>&lt;=</span> settings[<span style=color:#c30>&#39;mutate&#39;</span>]:

            <span style=color:#09f;font-style:italic># PICK WHICH WEIGHT MATRIX TO MUTATE</span>
            mat_pick <span style=color:#555>=</span> randint(<span style=color:#f60>0</span>,<span style=color:#f60>1</span>)     

            <span style=color:#09f;font-style:italic># MUTATE: WIH WEIGHTS</span>
            <span style=color:#069;font-weight:700>if</span> mat_pick <span style=color:#555>==</span> <span style=color:#f60>0</span>:
                index_row <span style=color:#555>=</span> randint(<span style=color:#f60>0</span>,settings[<span style=color:#c30>&#39;hnodes&#39;</span>]<span style=color:#555>-</span><span style=color:#f60>1</span>)
                wih_new[index_row] <span style=color:#555>=</span> wih_new[index_row] <span style=color:#555>*</span> uniform(<span style=color:#f60>0.9</span>, <span style=color:#f60>1.1</span>)
                <span style=color:#069;font-weight:700>if</span> wih_new[index_row] <span style=color:#555>&gt;</span>  <span style=color:#f60>1</span>: wih_new[index_row] <span style=color:#555>=</span> <span style=color:#f60>1</span>
                <span style=color:#069;font-weight:700>if</span> wih_new[index_row] <span style=color:#555>&lt;</span> <span style=color:#555>-</span><span style=color:#f60>1</span>: wih_new[index_row] <span style=color:#555>=</span> <span style=color:#555>-</span><span style=color:#f60>1</span>
                
            <span style=color:#09f;font-style:italic># MUTATE: WHO WEIGHTS</span>
            <span style=color:#069;font-weight:700>if</span> mat_pick <span style=color:#555>==</span> <span style=color:#f60>1</span>:
                index_row <span style=color:#555>=</span> randint(<span style=color:#f60>0</span>,settings[<span style=color:#c30>&#39;onodes&#39;</span>]<span style=color:#555>-</span><span style=color:#f60>1</span>)
                index_col <span style=color:#555>=</span> randint(<span style=color:#f60>0</span>,settings[<span style=color:#c30>&#39;hnodes&#39;</span>]<span style=color:#555>-</span><span style=color:#f60>1</span>)
                who_new[index_row][index_col] <span style=color:#555>=</span> who_new[index_row][index_col] <span style=color:#555>*</span> uniform(<span style=color:#f60>0.9</span>, <span style=color:#f60>1.1</span>)
                <span style=color:#069;font-weight:700>if</span> who_new[index_row][index_col] <span style=color:#555>&gt;</span>  <span style=color:#f60>1</span>: who_new[index_row][index_col] <span style=color:#555>=</span> <span style=color:#f60>1</span>
                <span style=color:#069;font-weight:700>if</span> who_new[index_row][index_col] <span style=color:#555>&lt;</span> <span style=color:#555>-</span><span style=color:#f60>1</span>: who_new[index_row][index_col] <span style=color:#555>=</span> <span style=color:#555>-</span><span style=color:#f60>1</span>
                    
        organisms_new<span style=color:#555>.</span>append(organism(settings, wih<span style=color:#555>=</span>wih_new, who<span style=color:#555>=</span>who_new, name<span style=color:#555>=</span><span style=color:#c30>&#39;gen[&#39;</span><span style=color:#555>+</span><span style=color:#366>str</span>(gen)<span style=color:#555>+</span><span style=color:#c30>&#39;]-org[&#39;</span><span style=color:#555>+</span><span style=color:#366>str</span>(w)<span style=color:#555>+</span><span style=color:#c30>&#39;]&#39;</span>))
                
    <span style=color:#069;font-weight:700>return</span> organisms_new, stats</code></pre></div><h2>Simulation</h2><p>The last critical piece of coding that's needed is something to actually run the simulation. This <i>simulate</i> function will effectively represent the <a target=_blank href=https://en.wikipedia.org/wiki/Loss_function>cost function</a> for our optimization problem and will be called once every generation. The duration of each simulation is determined by dividing the total simulation time <i>gen_time</i> (in seconds) by the duration of the time step; <i>dt</i>. As an example, if the simulation length is set at 100 seconds, and <i>dt</i> is equal to 1/25th of a second, then there will be a total of 2500 timesteps that need to be simulated. During each time step, several key values will be updated:</p><ul class=ul-style-a style=list-style-type:none><li><p markdown=1><b>Collision detection</b> - Here we are checking for collisions between organisms and food particles. When a collision is detected, that organism will get its fitness function updated and the food particle will respawn at a new random location.</p></li><li><p markdown=1><b>Determine closest food particle</b> - This one is fairly self explanitory. For every organism, the closest food particle must be determined.</p></li><li><p markdown=1><b>Determine direction to nearest food particle</b> - Once the nearest food particle has been determined for each organism, the direction to that particle must be calculated.</p></li><li><p markdown=1><b>Query neural network</b> - Using the updated (and normalized) direction value, the neural network in each organism is quaried.</p></li><li><p markdown=1><b>Update organism</b> - Based on the respone from the neural network, the heading, velocity, and position are all updated.</p></li></ul><p>Below is the simulation function:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>simulate</span>(settings, organisms, foods, gen):

    total_time_steps <span style=color:#555>=</span> <span style=color:#366>int</span>(settings[<span style=color:#c30>&#39;gen_time&#39;</span>] <span style=color:#555>/</span> settings[<span style=color:#c30>&#39;dt&#39;</span>])
    
    <span style=color:#09f;font-style:italic>#--- CYCLE THROUGH EACH TIME STEP ---------------------+</span>
    <span style=color:#069;font-weight:700>for</span> t_step <span style=color:#000;font-weight:700>in</span> <span style=color:#366>range</span>(<span style=color:#f60>0</span>, total_time_steps, <span style=color:#f60>1</span>):

        <span style=color:#09f;font-style:italic># PLOT SIMULATION FRAME</span>
        <span style=color:#09f;font-style:italic>#if gen == settings[&#39;gens&#39;] - 1 and settings[&#39;plot&#39;]==True:</span>
        <span style=color:#069;font-weight:700>if</span> gen<span style=color:#555>==</span><span style=color:#f60>49</span>:
            plot_frame(settings, organisms, foods, gen, t_step)
        

        <span style=color:#09f;font-style:italic># UPDATE FITNESS FUNCTION</span>
        <span style=color:#069;font-weight:700>for</span> food <span style=color:#000;font-weight:700>in</span> foods:
            <span style=color:#069;font-weight:700>for</span> org <span style=color:#000;font-weight:700>in</span> organisms:
                food_org_dist <span style=color:#555>=</span> dist(org<span style=color:#555>.</span>x, org<span style=color:#555>.</span>y, food<span style=color:#555>.</span>x, food<span style=color:#555>.</span>y)

                <span style=color:#09f;font-style:italic># UPDATE FITNESS FUNCTION</span>
                <span style=color:#069;font-weight:700>if</span> food_org_dist <span style=color:#555>&lt;=</span> <span style=color:#f60>0.075</span>:
                    org<span style=color:#555>.</span>fitness <span style=color:#555>+=</span> food<span style=color:#555>.</span>energy
                    food<span style=color:#555>.</span>respawn(settings)

                <span style=color:#09f;font-style:italic># RESET DISTANCE AND HEADING TO NEAREST FOOD SOURCE</span>
                org<span style=color:#555>.</span>d_food <span style=color:#555>=</span> <span style=color:#f60>100</span>
                org<span style=color:#555>.</span>r_food <span style=color:#555>=</span> <span style=color:#f60>0</span>

        <span style=color:#09f;font-style:italic># CALCULATE HEADING TO NEAREST FOOD SOURCE</span>
        <span style=color:#069;font-weight:700>for</span> food <span style=color:#000;font-weight:700>in</span> foods:
            <span style=color:#069;font-weight:700>for</span> org <span style=color:#000;font-weight:700>in</span> organisms:
                
                <span style=color:#09f;font-style:italic># CALCULATE DISTANCE TO SELECTED FOOD PARTICLE</span>
                food_org_dist <span style=color:#555>=</span> dist(org<span style=color:#555>.</span>x, org<span style=color:#555>.</span>y, food<span style=color:#555>.</span>x, food<span style=color:#555>.</span>y)

                <span style=color:#09f;font-style:italic># DETERMINE IF THIS IS THE CLOSEST FOOD PARTICLE</span>
                <span style=color:#069;font-weight:700>if</span> food_org_dist <span style=color:#555>&lt;</span> org<span style=color:#555>.</span>d_food:
                    org<span style=color:#555>.</span>d_food <span style=color:#555>=</span> food_org_dist
                    org<span style=color:#555>.</span>r_food <span style=color:#555>=</span> calc_heading(org, food)

        <span style=color:#09f;font-style:italic># GET ORGANISM RESPONSE</span>
        <span style=color:#069;font-weight:700>for</span> org <span style=color:#000;font-weight:700>in</span> organisms:
            org<span style=color:#555>.</span>think()

        <span style=color:#09f;font-style:italic># UPDATE ORGANISMS POSITION AND VELOCITY</span>
        <span style=color:#069;font-weight:700>for</span> org <span style=color:#000;font-weight:700>in</span> organisms:
            org<span style=color:#555>.</span>update_r(settings)
            org<span style=color:#555>.</span>update_vel(settings)
            org<span style=color:#555>.</span>update_pos(settings)

    <span style=color:#069;font-weight:700>return</span> organisms</code></pre></div><h2>Putting it All Together</h2><p>With all the major components having been created the final code can now be assembled. There are a few smaller functions I neglected to include in the above writeup because they're so simple reading about them would take longer than just reading the code directly. I ended up using <a target=_blank href=https://matplotlib.org/>matplotlib</a> for displaying the simulation. This is far from the most efficient or elligant solution so by default the visualization is turned off. Lastly, pasting the entire code would be a bit redundent at this point so download/fork it from the GitHub repo (<a target=_blank href=https://github.com/nathanrooy/evolving-simple-organisms/blob/master/organism_v1.py>here</a>).</p><h2 id=results>Results</h2><p>When you run the entire code, the output should be something similar to this:</p><p><center><fig><img src=results.gif></fig></center></p><p>I hope this was helpful. If anything seems unclear, please let me know. Thanks for reading!</p></div><div class=separator><ul class=flat><li><a onclick="plausible('home-icon',{props:{method:'Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python'}})" href=/><img style=min-width:30px;position:relative;top:5px;width:20px;height:20px src=/icons/home_feather.svg alt="home page icon"></a></li><li><a onclick="plausible('about-icon',{props:{method:'Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python'}})" href=/about><img style=min-width:30px;position:relative;top:5px;width:20px;height:20px src=/icons/user_feather.svg alt="about page icon"></a></li><li><a onclick="plausible('rss-icon',{props:{method:'Evolving Simple Organisms using a Genetic Algorithm and Deep Learning from Scratch with Python'}})" href=/rss target=_blank><img style=min-width:30px;position:relative;top:5px;width:20px;height:20px src=/icons/rss_feather_black.svg alt="rss page icon"></a></li></ul></div></div><footer><center>&copy; <a href=/about>Nathan A. Rooy</a>.<br>Built with <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>.
Powered by <a target=_blank rel="noopener noreferrer" href=http://www.github.com>GitHub</a></center></footer></body></html>